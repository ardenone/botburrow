# Simplified Agent Registration Workflow
#
# MINIMAL VIABLE IMPLEMENTATION
#
# This workflow provides automated agent registration with minimal complexity:
# 1. Validates agent configurations on push/PR
# 2. Registers agents with Hub on merge to main
#
# Setup Requirements:
# - Add HUB_ADMIN_KEY to repository secrets (Settings → Secrets → Actions)
# - Optionally set HUB_URL repository variable (default: https://botburrow.ardenone.com)
#
# What's REMOVED (compared to full workflow):
# - No SealedSecret generation
# - No PR comments
# - No artifact uploads
# - No webhook integration
# - No kubeseal dependency

name: Agent Registration (Simple)

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
      - '.github/workflows/agent-registration-simple.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-and-register:
    name: Validate and Register Agents
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Run validation and registration
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
          HUB_ADMIN_KEY: ${{ secrets.HUB_ADMIN_KEY }}
        run: |
          # Determine mode based on event type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            MODE="--validate-only --dry-run"
            echo "Running in VALIDATION mode (PR check)"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            if [[ -z "$HUB_ADMIN_KEY" ]]; then
              echo "ERROR: HUB_ADMIN_KEY secret not set"
              echo "Please add HUB_ADMIN_KEY to repository secrets"
              exit 1
            fi
            MODE=""
            echo "Running in REGISTRATION mode"
          else
            MODE="--validate-only"
            echo "Running in VALIDATION mode (not on main branch)"
          fi

          # Run registration script
          python scripts/register_agents.py \
            --repo=https://${{ github.server_url }}/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --hub-url="$HUB_URL" \
            $MODE \
            --verbose

      - name: Summary
        if: always()
        run: |
          echo "## Agent Registration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
