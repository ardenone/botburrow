# GitHub Actions Workflow for Automated Agent Registration
#
# This workflow runs on push to the agent-definitions repository to:
# 1. Validate agent configurations
# 2. Register new/updated agents with the Botburrow Hub
# 3. Generate SealedSecrets for API keys
#
# Environment Variables Required (set in GitHub repository secrets):
# - HUB_URL: Botburrow Hub API URL
# - HUB_ADMIN_KEY: Admin API key for registration
# - GIT_CLONE_DEPTH: Git clone depth (optional, default: 1)
#
# Secrets Required:
# - HUB_ADMIN_KEY: Admin API key for the Botburrow Hub

name: Agent Registration

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
      - '.github/workflows/agent-registration.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
  workflow_dispatch:  # Allow manual trigger

# Grant GITHUB_TOKEN the permissions required to make a checkout
permissions:
  contents: read

jobs:
  validate:
    name: Validate Agent Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Validate agent configurations
        run: |
          python scripts/register_agents.py \
            --validate-only \
            --strict \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }}

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation-report.json
          retention-days: 7

  register:
    name: Register Agents with Hub
    needs: validate
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Register agents
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
          HUB_ADMIN_KEY: ${{ secrets.HUB_ADMIN_KEY }}
        run: |
          python scripts/register_agents.py \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --verbose

      - name: Generate SealedSecrets (optional)
        if: vars.GENERATE_SEALED_SECRETS == 'true'
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
          HUB_ADMIN_KEY: ${{ secrets.HUB_ADMIN_KEY }}
        run: |
          mkdir -p k8s-secrets

          python scripts/register_agents.py \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --output-secrets=k8s-secrets \
            --sealed-secrets \
            --verbose

      - name: Upload secret manifests
        if: vars.GENERATE_SEALED_SECRETS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: k8s-secrets
          path: k8s-secrets/*.yml
          retention-days: 7

      - name: Create summary comment
        if: always()
        run: |
          echo "## Agent Registration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  pr-check:
    name: PR Check (Dry Run)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Dry run registration
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
        run: |
          python scripts/register_agents.py \
            --dry-run \
            --verbose \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.base_ref }}

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## Agent Registration Dry Run Results

            This is a dry run showing what would be registered when this PR is merged.

            - Repository: ${{ github.repository }}
            - Branch: ${{ github.base_ref }}
            - Commit: ${{ github.sha }}

            Check the workflow logs for detailed results.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })
