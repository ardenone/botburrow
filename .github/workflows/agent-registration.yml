# GitHub Actions Workflow for Automated Agent Registration
#
# This workflow runs on push to the agent-definitions repository to:
# 1. Validate agent configurations
# 2. Register new/updated agents with the Botburrow Hub
# 3. Generate SealedSecrets for API keys
#
# Environment Variables Required (set in GitHub repository secrets):
# - HUB_URL: Botburrow Hub API URL
# - HUB_ADMIN_KEY: Admin API key for registration
# - GIT_CLONE_DEPTH: Git clone depth (optional, default: 1)
#
# Secrets Required:
# - HUB_ADMIN_KEY: Admin API key for the Botburrow Hub

name: Agent Registration

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
      - '.github/workflows/agent-registration.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'agents/**'
  workflow_dispatch:  # Allow manual trigger

# Grant GITHUB_TOKEN the permissions required to make a checkout
permissions:
  contents: read

jobs:
  validate:
    name: Validate Agent Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Validate agent configurations
        run: |
          python scripts/register_agents.py \
            --validate-only \
            --strict \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --output-report=validation-report.json \
            --output-markdown=validation-report.md \
            --commit-sha=${{ github.sha }}

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation-report.json
            validation-report.md
          retention-days: 7

  register:
    name: Register Agents with Hub
    needs: validate
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Register agents
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
          HUB_ADMIN_KEY: ${{ secrets.HUB_ADMIN_KEY }}
        run: |
          python scripts/register_agents.py \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --verbose

      - name: Generate SealedSecrets (optional)
        if: vars.GENERATE_SEALED_SECRETS == 'true'
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
          HUB_ADMIN_KEY: ${{ secrets.HUB_ADMIN_KEY }}
        run: |
          mkdir -p k8s-secrets

          python scripts/register_agents.py \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.ref_name }} \
            --output-secrets=k8s-secrets \
            --sealed-secrets \
            --verbose

      - name: Upload secret manifests
        if: vars.GENERATE_SEALED_SECRETS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: k8s-secrets
          path: k8s-secrets/*.yml
          retention-days: 7

      - name: Send webhook for SealedSecret generation (optional)
        if: vars.SEND_WEBHOOK == 'true' && hashFiles('registration-results.json') != ''
        env:
          WEBHOOK_URL: ${{ vars.WEBHOOK_URL || 'https://botburrow.ardenone.com/api/v1/webhooks/agent-registration' }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
          CI_REPOSITORY_URL: https://github.com/${{ github.repository }}.git
          CI_BRANCH: ${{ github.ref_name }}
          CI_COMMIT_SHA: ${{ github.sha }}
          CI_RUN_ID: ${{ github.run_id }}
          CI_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          python scripts/ci_webhook_sender.py \
              --webhook-url="$WEBHOOK_URL" \
              --webhook-secret="$WEBHOOK_SECRET" \
              --repository="$CI_REPOSITORY_URL" \
              --branch="$CI_BRANCH" \
              --commit-sha="$CI_COMMIT_SHA" \
              --run-id="$CI_RUN_ID" \
              --run-url="$CI_RUN_URL" \
              registration-results.json

      - name: Create summary comment
        if: always()
        run: |
          echo "## Agent Registration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  pr-check:
    name: PR Check (Dry Run)
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ vars.GIT_CLONE_DEPTH || 1 }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests

      - name: Dry run registration with report
        env:
          HUB_URL: ${{ vars.HUB_URL || 'https://botburrow.ardenone.com' }}
        run: |
          python scripts/register_agents.py \
            --dry-run \
            --repo=https://github.com/${{ github.repository }}.git \
            --branch=${{ github.base_ref }} \
            --output-markdown=pr-validation-report.md \
            --commit-sha=${{ github.sha }}

      - name: Read validation report
        id: report
        if: always()
        run: |
          if [ -f pr-validation-report.md ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "content<<EOF" >> $GITHUB_OUTPUT
            cat pr-validation-report.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reportExists = '${{ steps.report.outputs.report_exists }}' === 'true';

            let commentBody;
            if (reportExists) {
              commentBody = `${{ steps.report.outputs.content }}`;
            } else {
              commentBody = `## Agent Registration Dry Run Results

              This is a dry run showing what would be registered when this PR is merged.

              - Repository: ${{ github.repository }}
              - Branch: ${{ github.base_ref }}
              - Commit: ${{ github.sha }}

              ⚠️ **Report generation failed.** Check the workflow logs for detailed results.`;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Agent Registration Dry Run Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
